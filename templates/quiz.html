{% extends "base.html" %}

{% block title %}{{ quiz_title }} - Security+ Exam Prep{% endblock %}

{% block content %}
<div class="quiz-container">
    <div class="quiz-header">
        <div class="container">
            <div class="quiz-header-content">
                <h1>{{ quiz_title }}</h1>
                <div class="quiz-info">
                    <span class="quiz-type">{{ quiz_type }}</span>
                </div>
            </div>
        </div>
    
    </div>

    <div class="quiz-main">
        <div class="container">
            <div class="quiz-progress">
                <div class="progress-bar">
                    <div class="progress-fill" data-progress="{{ progress_percentage }}"></div>
                </div>
                <div class="progress-info">
                    <div class="progress-text">
                        <span class="current-question">{{ current_question_number }}</span>
                        <span class="separator">of</span>
                        <span class="total-questions">{{ total_questions }}</span>
                    </div>
                    <div class="timer-display" id="timer-display" style="display: none;">
                        <i class="fas fa-clock"></i>
                        <span id="timer-text">90:00</span>
                    </div>
                </div>
            </div>

            <div class="question-container">
                <div class="question-header">
                    <span class="question-type">{{ current_question.question_type.replace('_', ' ').title() }}</span>
                </div>
                
                <div class="question-text">
                    <h3>{{ current_question.question_text }}</h3>
                </div>
                
                <form id="quizForm" action="{{ url_for('submit_quiz_answer', quiz_id=quiz_id) }}" method="POST">
                {% if current_question.question_type in ['multiple_choice', 'concept_multiple_choice', 'scenario_multiple_choice'] %}
                <div class="question-options">
                    {% for option in current_question.options %}
                    {% set option_index = loop.index0 %}
                    {% set is_user_answer = show_explanation and user_answer|string == option_index|string %}
                    {% set is_correct_answer = show_explanation and correct_answer_index is not none and correct_answer_index == option_index %}
                    <label class="option-item {% if show_explanation %}{% if is_correct_answer %}correct-answer{% elif is_user_answer and not is_correct %}incorrect-answer{% endif %}{% endif %}">
                        <input type="radio" name="answer" value="{{ option_index }}" required {% if show_explanation %}disabled{% endif %}>
                        <span class="option-letter">{{ option_index|string|replace('0', 'A')|replace('1', 'B')|replace('2', 'C')|replace('3', 'D') }}</span>
                        <span class="option-text">{{ option }}</span>
                        {% if show_explanation %}
                            {% if is_correct_answer %}
                            <span class="answer-indicator correct-indicator"><i class="fas fa-check-circle"></i> Correct</span>
                            {% elif is_user_answer and not is_correct %}
                            <span class="answer-indicator incorrect-indicator"><i class="fas fa-times-circle"></i> Your Answer</span>
                            {% endif %}
                        {% endif %}
                    </label>
                    {% endfor %}
                </div>
                {% elif current_question.question_type == 'true_false' %}
                <div class="question-options">
                    {% set user_ans = user_answer|lower if show_explanation else '' %}
                    {% set correct_ans = correct_answer|lower if show_explanation else '' %}
                    <label class="option-item {% if show_explanation %}{% if correct_ans == 'true' %}correct-answer{% elif user_ans == 'true' and not is_correct %}incorrect-answer{% endif %}{% endif %}">
                        <input type="radio" name="answer" value="true" required {% if show_explanation %}disabled{% endif %}>
                        <span class="option-letter">A</span>
                        <span class="option-text">True</span>
                        {% if show_explanation %}
                            {% if correct_ans == 'true' %}
                            <span class="answer-indicator correct-indicator"><i class="fas fa-check-circle"></i> Correct</span>
                            {% elif user_ans == 'true' and not is_correct %}
                            <span class="answer-indicator incorrect-indicator"><i class="fas fa-times-circle"></i> Your Answer</span>
                            {% endif %}
                        {% endif %}
                    </label>
                    <label class="option-item {% if show_explanation %}{% if correct_ans == 'false' %}correct-answer{% elif user_ans == 'false' and not is_correct %}incorrect-answer{% endif %}{% endif %}">
                        <input type="radio" name="answer" value="false" required {% if show_explanation %}disabled{% endif %}>
                        <span class="option-letter">B</span>
                        <span class="option-text">False</span>
                        {% if show_explanation %}
                            {% if correct_ans == 'false' %}
                            <span class="answer-indicator correct-indicator"><i class="fas fa-check-circle"></i> Correct</span>
                            {% elif user_ans == 'false' and not is_correct %}
                            <span class="answer-indicator incorrect-indicator"><i class="fas fa-times-circle"></i> Your Answer</span>
                            {% endif %}
                        {% endif %}
                    </label>
                </div>
                {% elif current_question.question_type in ['fill_in_blank', 'fill_in_the_blank'] %}
                <div class="question-input">
                    <input type="text" name="answer" placeholder="Enter your answer..." required {% if show_explanation %}disabled value="{{ user_answer }}"{% endif %}>
                    {% if show_explanation %}
                    <div class="fill-answer-feedback">
                        <p><strong>Your answer:</strong> {{ user_answer }}</p>
                        <p><strong>Correct answer:</strong> {{ correct_answer }}</p>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <!-- Default to multiple choice if type not recognized -->
                <div class="question-options">
                    {% for option in current_question.options %}
                    {% set option_index = loop.index0 %}
                    {% set is_user_answer = show_explanation and user_answer|string == option_index|string %}
                    {% set is_correct_answer = show_explanation and correct_answer_index is not none and correct_answer_index == option_index %}
                    <label class="option-item {% if show_explanation %}{% if is_correct_answer %}correct-answer{% elif is_user_answer and not is_correct %}incorrect-answer{% endif %}{% endif %}">
                        <input type="radio" name="answer" value="{{ option_index }}" required {% if show_explanation %}disabled{% endif %}>
                        <span class="option-letter">{{ option_index|string|replace('0', 'A')|replace('1', 'B')|replace('2', 'C')|replace('3', 'D') }}</span>
                        <span class="option-text">{{ option }}</span>
                        {% if show_explanation %}
                            {% if is_correct_answer %}
                            <span class="answer-indicator correct-indicator"><i class="fas fa-check-circle"></i> Correct</span>
                            {% elif is_user_answer and not is_correct %}
                            <span class="answer-indicator incorrect-indicator"><i class="fas fa-times-circle"></i> Your Answer</span>
                            {% endif %}
                        {% endif %}
                    </label>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            {% if not show_explanation %}
            <div class="quiz-actions">
                {% if current_question_number > 1 %}
                <a href="{{ url_for('quiz_question', quiz_id=quiz_id, question_number=current_question_number - 1) }}" class="btn btn-outline">
                    <i class="fas fa-arrow-left"></i>
                    Previous
                </a>
                {% endif %}
                <button class="btn btn-outline" id="skipQuestion" type="submit" name="answer" value="skip" formnovalidate>
                    <i class="fas fa-forward"></i>
                    Skip
                </button>
                <button class="btn btn-primary" id="submitAnswer" type="submit" disabled>
                    Submit Answer
                </button>
            </div>
            {% endif %}
            </form>

            <!-- Explanation (shown after answer submission) -->
            {% if show_explanation %}
            <div class="explanation-container" id="explanation">
                <div class="explanation-header">
                    <h4>
                        {% if is_correct %}
                        <i class="fas fa-check-circle correct"></i>
                        Correct!
                        {% else %}
                        <i class="fas fa-times-circle incorrect"></i>
                        Incorrect
                        {% endif %}
                    </h4>
                </div>
                <div class="explanation-content">
                    {% if explanation %}
                    <p><strong>Explanation:</strong> {{ explanation }}</p>
                    {% elif current_question.get('explanation') %}
                    <p><strong>Explanation:</strong> {{ current_question.explanation }}</p>
                    {% endif %}
                </div>
                <div class="explanation-actions">
                    {% if current_question_number < total_questions %}
                    <a href="{{ url_for('quiz_question', quiz_id=quiz_id, question_number=current_question_number + 1) }}" class="btn btn-primary" id="nextQuestion">
                        Next Question
                    </a>
                    {% else %}
                    <a href="{{ url_for('quiz_results', quiz_id=quiz_id) }}" class="btn btn-primary" id="viewResults">
                        View Results
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.quiz-progress {
    margin-bottom: 30px;
}

.progress-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 12px;
}

.timer-display {
    display: flex;
    align-items: center;
    gap: 8px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 10px 20px;
    border-radius: 25px;
    font-weight: 600;
    font-size: 1.1rem;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.timer-display.warning {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.quiz-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    flex-wrap: wrap;
}

.quiz-actions .btn {
    flex-shrink: 0;
}

.option-item.correct-answer {
    background: #d4edda;
    border: 2px solid #28a745;
    border-radius: 8px;
}

.option-item.incorrect-answer {
    background: #f8d7da;
    border: 2px solid #dc3545;
    border-radius: 8px;
}

.answer-indicator {
    margin-left: auto;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
}

.correct-indicator {
    color: #28a745;
}

.incorrect-indicator {
    color: #dc3545;
}

.fill-answer-feedback {
    margin-top: 12px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}

.explanation-container {
    margin-top: 24px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 12px;
    border: 2px solid #dee2e6;
}

.explanation-header h4 {
    margin: 0 0 16px 0;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 1.25rem;
}

.explanation-header .correct {
    color: #28a745;
}

.explanation-header .incorrect {
    color: #dc3545;
}

.explanation-content {
    margin-bottom: 20px;
    line-height: 1.6;
    color: #333;
}

.explanation-content p {
    margin: 8px 0;
}

.explanation-actions {
    display: flex;
    justify-content: flex-end;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const submitBtn = document.getElementById('submitAnswer');
    const answerInputs = document.querySelectorAll('input[name="answer"][type="radio"]');
    const answerText = document.querySelector('input[name="answer"][type="text"]');
    const progressFill = document.querySelector('.progress-fill');
    const quizId = '{{ quiz_id }}';
    const questionNumber = parseInt('{{ current_question_number }}', 10);
    
    if (progressFill && progressFill.dataset.progress) {
        progressFill.style.width = progressFill.dataset.progress + '%';
    }
    
    // Answer persistence - save answers to sessionStorage
    function saveAnswer(answer) {
        const storageKey = `quiz_${quizId}_answers`;
        let answers = {};
        try {
            const stored = sessionStorage.getItem(storageKey);
            if (stored) answers = JSON.parse(stored);
        } catch (e) {
            console.error('Error loading saved answers:', e);
        }
        answers[questionNumber] = answer;
        sessionStorage.setItem(storageKey, JSON.stringify(answers));
    }
    
    function loadSavedAnswer() {
        const storageKey = `quiz_${quizId}_answers`;
        try {
            const stored = sessionStorage.getItem(storageKey);
            if (stored) {
                const answers = JSON.parse(stored);
                const savedAnswer = answers[questionNumber];
                if (savedAnswer !== undefined && savedAnswer !== null) {
                    // Restore the answer
                    if (answerText && typeof savedAnswer === 'string') {
                        answerText.value = savedAnswer;
                    } else if (answerInputs.length > 0) {
                        answerInputs.forEach(input => {
                            if (input.value == savedAnswer) {
                                input.checked = true;
                            }
                        });
                    }
                }
            }
        } catch (e) {
            console.error('Error loading saved answer:', e);
        }
    }
    
    // Load saved answer on page load
    loadSavedAnswer();
    
    // If showing explanation, pre-select the user's answer
    {% if show_explanation %}
    const userAnswer = '{{ user_answer }}';
    if (answerText) {
        answerText.value = userAnswer;
    } else if (answerInputs.length > 0) {
        answerInputs.forEach(input => {
            if (input.value == userAnswer) {
                input.checked = true;
            }
        });
    }
    {% endif %}
    
    // Timer functionality
    const timerDisplay = document.getElementById('timer-display');
    const timerText = document.getElementById('timer-text');
    const urlParams = new URLSearchParams(window.location.search);
    const showTimer = urlParams.get('timer') === 'true';
    const timeLimit = parseInt(urlParams.get('time_limit') || '5400'); // Default 90 minutes in seconds
    
    if (showTimer && timerDisplay) {
        timerDisplay.style.display = 'flex';
        let remainingTime = timeLimit;
        
        // Check if we have a saved time in sessionStorage
        const savedTime = sessionStorage.getItem('quiz_timer');
        const savedTimestamp = sessionStorage.getItem('quiz_timer_start');
        if (savedTime && savedTimestamp) {
            const elapsed = Math.floor((Date.now() - parseInt(savedTimestamp)) / 1000);
            remainingTime = Math.max(0, parseInt(savedTime) - elapsed);
        } else {
            sessionStorage.setItem('quiz_timer', timeLimit.toString());
            sessionStorage.setItem('quiz_timer_start', Date.now().toString());
        }
        
        function updateTimer() {
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            timerText.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Warning color when under 10 minutes
            if (remainingTime < 600) {
                timerDisplay.classList.add('warning');
            }
            
            if (remainingTime <= 0) {
                alert('Time is up! Submitting your test...');
                window.location.href = '/quiz/{{ quiz_id }}/results';
                return;
            }
            
            remainingTime--;
            sessionStorage.setItem('quiz_timer', remainingTime.toString());
            sessionStorage.setItem('quiz_timer_start', Date.now().toString());
        }
        
        updateTimer();
        const timerInterval = setInterval(updateTimer, 1000);
    }
    
    // Enable submit button when answer is selected
    function checkAnswerSelected() {
        let hasAnswer = false;
        let selectedAnswer = null;
        
        if (answerText) {
            hasAnswer = answerText.value.trim() !== '';
            selectedAnswer = answerText.value.trim();
        } else {
            answerInputs.forEach(input => {
                if (input.checked) {
                    hasAnswer = true;
                    selectedAnswer = input.value;
                }
            });
        }
        
        submitBtn.disabled = !hasAnswer;
        
        // Save answer when selected
        if (hasAnswer && selectedAnswer !== null) {
            saveAnswer(selectedAnswer);
        }
    }
    
    // Add event listeners
    answerInputs.forEach(input => {
        input.addEventListener('change', checkAnswerSelected);
    });
    
    if (answerText) {
        answerText.addEventListener('input', checkAnswerSelected);
    }
    
    // Form submission is handled by the browser; Flask returns a redirect
    
    // Initialize
    checkAnswerSelected();
});
</script>
{% endblock %}
